<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="//www.brightcove.com/favicon.svg">
  <title>Brightcove - Cue Points Player</title>
  <style>
    #video_details {
      display: flex;
      justify-content: center;
      grid-gap: 40px;
      margin: 1em 0 0 0;
    }

    #container {
      display: flex;
      justify-content: center;
      grid-gap: 20px;
    }

    #video {
      flex-basis: 960px;
      padding-top: 30px;
    }

    .label {
      font-family: Arial, Helvetica, sans-serif;
    }

    #debug {
      font-family: Arial, Helvetica, sans-serif;
      font-size: small;
    }

    #debug code {
      color: #666;
      font-size: 14px;
      background-color: #d5d5d5;
      border-radius: 3px;
      padding: 1px 5px;
    }

    .vjs-cue-control {
      position: absolute;
      height: 100%;
      width: var(--cue-control-width);
    }

    /* Ainmations */
    @keyframes expand-marker {
      0% {
        transform: scaleX(1);
      }

      50% {
        transform: scaleX(2);
      }

      100% {
        transform: scaleX(1.5);
      }
    }

    @keyframes contract-marker {
      0% {
        transform: scaleX(1.5);
      }

      100% {
        transform: scaleX(1);
      }
    }

    @keyframes ball {
      75% {
        transform: scale(4);
        opacity: 50%;
      }

      100% {
        transform: scale(1.5);
      }
    }

    @keyframes line {
      0% {
        transform: scale(1.5);
      }

      100% {
        transform: scaleX(1);
        height: 100%;
      }
    }

    /* Styles generated by SCSS  */
    .vjs-cue-marker:nth-child(1) {
      animation-delay: 80ms;
    }

    .vjs-cue-marker:nth-child(2) {
      animation-delay: 160ms;
    }

    .vjs-cue-marker:nth-child(3) {
      animation-delay: 240ms;
    }

    .vjs-cue-marker:nth-child(4) {
      animation-delay: 320ms;
    }

    .vjs-cue-marker:nth-child(5) {
      animation-delay: 400ms;
    }

    .vjs-cue-marker:nth-child(6) {
      animation-delay: 480ms;
    }

    .vjs-cue-marker:nth-child(7) {
      animation-delay: 560ms;
    }

    .vjs-cue-marker:nth-child(8) {
      animation-delay: 640ms;
    }

    .vjs-cue-marker:nth-child(9) {
      animation-delay: 720ms;
    }

    .vjs-cue-marker:nth-child(10) {
      animation-delay: 800ms;
    }

    .vjs-cue-marker:nth-child(11) {
      animation-delay: 880ms;
    }

    .vjs-cue-marker:nth-child(12) {
      animation-delay: 960ms;
    }

    .vjs-cue-marker:nth-child(13) {
      animation-delay: 1040ms;
    }

    .vjs-cue-marker:nth-child(14) {
      animation-delay: 1120ms;
    }

    .vjs-cue-marker:nth-child(15) {
      animation-delay: 1200ms;
    }

    .vjs-cue-marker:nth-child(16) {
      animation-delay: 1280ms;
    }

    .vjs-cue-marker:nth-child(17) {
      animation-delay: 1360ms;
    }

    .vjs-cue-marker:nth-child(18) {
      animation-delay: 1440ms;
    }

    .vjs-cue-marker:nth-child(19) {
      animation-delay: 1520ms;
    }

    .vjs-cue-marker:nth-child(20) {
      animation-delay: 1600ms;
    }

    .vjs-cue-marker:nth-child(21) {
      animation-delay: 1680ms;
    }

    .vjs-cue-marker:nth-child(22) {
      animation-delay: 1760ms;
    }

    .vjs-cue-marker:nth-child(23) {
      animation-delay: 1840ms;
    }

    .vjs-cue-marker:nth-child(24) {
      animation-delay: 1920ms;
    }

    .vjs-cue-marker:nth-child(25) {
      animation-delay: 2000ms;
    }

    .vjs-cue-marker:nth-child(26) {
      animation-delay: 2080ms;
    }

    .vjs-cue-marker:nth-child(27) {
      animation-delay: 2160ms;
    }

    .vjs-cue-marker:nth-child(28) {
      animation-delay: 2240ms;
    }

    .vjs-cue-marker:nth-child(29) {
      animation-delay: 2320ms;
    }

    .vjs-cue-marker:nth-child(30) {
      animation-delay: 2400ms;
    }

    .vjs-cue-marker:nth-child(31) {
      animation-delay: 2480ms;
    }

    .vjs-cue-marker:nth-child(32) {
      animation-delay: 2560ms;
    }

    .vjs-cue-marker:nth-child(33) {
      animation-delay: 2640ms;
    }

    .vjs-cue-marker:nth-child(34) {
      animation-delay: 2720ms;
    }

    .vjs-cue-marker:nth-child(35) {
      animation-delay: 2800ms;
    }

    .vjs-cue-marker:nth-child(36) {
      animation-delay: 2880ms;
    }

    .vjs-cue-marker:nth-child(37) {
      animation-delay: 2960ms;
    }

    .vjs-cue-marker:nth-child(38) {
      animation-delay: 3040ms;
    }

    .vjs-cue-marker:nth-child(39) {
      animation-delay: 3120ms;
    }

    .vjs-cue-marker:nth-child(40) {
      animation-delay: 3200ms;
    }

    .vjs-cue-marker:nth-child(41) {
      animation-delay: 3280ms;
    }

    .vjs-cue-marker:nth-child(42) {
      animation-delay: 3360ms;
    }

    .vjs-cue-marker:nth-child(43) {
      animation-delay: 3440ms;
    }

    .vjs-cue-marker:nth-child(44) {
      animation-delay: 3520ms;
    }

    .vjs-cue-marker:nth-child(45) {
      animation-delay: 3600ms;
    }

    .vjs-cue-marker:nth-child(46) {
      animation-delay: 3680ms;
    }

    .vjs-cue-marker:nth-child(47) {
      animation-delay: 3760ms;
    }

    .vjs-cue-marker:nth-child(48) {
      animation-delay: 3840ms;
    }

    .vjs-cue-marker:nth-child(49) {
      animation-delay: 3920ms;
    }

    .vjs-cue-marker {
      position: absolute;
      background-color: transparent;
      animation: 300ms ease-out forwards ball;
      width: 4px;
      height: 4px;
      z-index: 3;
      bottom: 0px;
    }

    .vjs-cue-marker:hover {
      opacity: 100% !important;
    }

    .vjs-cue-marker::before {
      animation: contract-marker 500ms ease-in;
      border-radius: 50%;
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0px;
      background-color: var(--marker-color);
      content: "";
    }

    .vjs-cue-marker:hover::before {
      border-radius: 1px;
      animation: expand-marker 300ms ease forwards;
    }

    .initial-marker:hover {
      transform: translateX(1px) !important;
      content: "";
    }

    .video-js:hover .vjs-cue-marker {
      opacity: 50%;
      bottom: unset;
      animation: line 500ms ease forwards;
    }

    .video-js:hover .vjs-cue-marker::before {
      border-radius: 0px;
    }

    .vjs-progress-control:hover .vjs-cue-marker {
      height: 170% !important;
      transform: translateY(-5px) !important;
    }

    .vjs-progress-control:hover .vjs-cue-marker::before {
      border-radius: 1px;
    }

    /* Tooltip animations */
    @keyframes fade-out {
      from {
        visibility: visible;
      }

      to {
        transform: translateY(5px);
        opacity: 0;
      }
    }

    .vjs-cue-tip {
      animation: fade-out 300ms ease-out;
      position: absolute;
      pointer-events: none;
      visibility: hidden;
      z-index: 4;
    }

    /* Tooltip animations */
    @keyframes fade-in {
      from {
        transform: translateY(5px);
        opacity: 0;
      }
    }

    .vjs-cue-tip-visible {
      animation: fade-in 300ms ease-out;
      visibility: visible;
    }

    .vjs-cue-data {
      color: #e0e0e0;
      border: 1px solid transparent;
      font-size: 12px;
      border-radius: 0.3em;
      background-color: #000;
      padding: 4px 8px;
      margin-top: 12px;
      -webkit-filter: drop-shadow(0px 1px 0px rgb(165, 165, 165)) drop-shadow(0px -1px 0px rgb(165, 165, 165)) drop-shadow(-1px 0px 0px rgb(165, 165, 165)) drop-shadow(1px 0px 0px rgb(165, 165, 165));
      filter        : drop-shadow(0px 1px 0px rgb(165, 165, 165)) drop-shadow(0px -1px 0px rgb(165, 165, 165)) drop-shadow(-1px 0px 0px rgb(165, 165, 165)) drop-shadow(1px 0px 0px rgb(165, 165, 165));
      -ms-filter    : "progid:DXImageTransform.Microsoft.Dropshadow(OffX=0, OffY=1, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=0, OffY=-1, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=1, OffY=0, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=-1, OffY=0, Color='#BBB')";
      filter        : "progid:DXImageTransform.Microsoft.Dropshadow(OffX=0, OffY=1, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=0, OffY=-1, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=1, OffY=0, Color='#BBB') progid:DXImageTransform.Microsoft.Dropshadow(OffX=-1, OffY=0, Color='#BBB')";
    }

    .vjs-cue-tip .vjs-cue-data-left::after {
      content: "";
      position: absolute;
      top: 35%;
      left: 100%;
      margin-top: -5px;
      border-width: 8px;
      border-style: solid;
      border-color: transparent transparent transparent black;
    }

    .vjs-cue-tip .vjs-cue-data-right::before {
      content: "";
      position: absolute;
      top: 35%;
      right: 100%;
      margin-top: -5px;
      border-width: 8px;
      border-style: solid;
      border-color: transparent black transparent transparent;
    }

    /* Hide cue points display on mobile */
    @media screen and (min-device-width: 768px) and (max-device-width: 1024px) {
      .vjs-cue-marker {
        display: none;
      }

      .vjs-cue-tip {
        display: none;
      }

      .vjs-cue-data {
        display: none;
      }
      
    }

    @media screen and (max-device-width: 480px) and (orientation: portrait) {
      .vjs-cue-marker {
        display: none;
      }

      .vjs-cue-tip {
        display: none;
      }

      .vjs-cue-data {
        display: none;
      }
    
      /* Styles for portrait layout - mobile */

      #chapter_col_wrapper, .chapter_col {
        display: block !important;
        width:100% !important;
      }

      #chapter_right_arrow_container, #chapter_left_arrow_container{
        display: none;
      }

      .chapter_col{
        margin: 12px 0px !important;
      }

      .chapter_anchor{
        display: flex !important;
        border-radius: 5px !important;
      }
      
      .chapter_thumbnail{
        width: unset !important;
        border-radius: 5px !important;
        height: 12vh;
        margin: auto 4px;
      }
      
      .chapter_details{
        left: 15px;
        position: relative;
      }

    }

    @media screen and (max-device-width: 640px) and (orientation: landscape) {
      .vjs-cue-marker {
        display: none;
      }

      .vjs-cue-tip {
        display: none;
      }

      .vjs-cue-data {
        display: none;
      }

    }

    @media screen and (max-device-width: 640px) {
      .vjs-cue-marker {
        display: none;
      }

      .vjs-cue-tip {
        display: none;
      }

      .vjs-cue-data {
        display: none;
      }

      /* Styles for portrait layout - mobile */

      #chapter_col_wrapper, .chapter_col {
        display: block !important;
        width:100% !important;
      }

      #chapter_right_arrow_container, #chapter_left_arrow_container{
        display: none;
      }

      .chapter_col{
        margin: 12px 0px !important;
      }

      .chapter_anchor{
        display: flex !important;
        border-radius: 5px !important;
      }
      .chapter_thumbnail{
        width: unset !important;
        border-radius: 5px !important;
        height: 12vh;
        margin: auto 4px;
      }
      
      .chapter_details{
        left: 15px;
        position: relative;
      }

    }

    #vjs-chapter-container {
      font-family: "PP Agrandir","Articulat CF",Montserrat,Arial,Helvetica,sans-serif;
      position: relative;
      background-color: var(--chapter-color);
      top: 100%;
    }

    #chapter_col_container {
      display: flex;
      overflow-x: hidden;
    }

    #chapter_col_wrapper {
      display: flex;
      position: relative;
      transition: transform 0.5s ease-in-out;
    }

    #chapter_title {
      font-size: large;
      color: #000;
      margin: 0 0 0 8px;
      padding-top: 16px;
    }

    .chapter_arrow_container {
      position: absolute;
      top: 0;
      bottom: 0;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    #chapter_right_arrow_container {
      right: 20px;
    }

    #chapter_left_arrow_container {
      left: 20px;
    }

    .chapter_arrow {
      pointer-events: all;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 24px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, .7), 0 0 4px rgba(0, 0, 0, .5);
      background-color: #FFF;
    }

    .chapter_arrow_chevron {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      vertical-align: middle;
      fill: #FFF;
      height: 100%;
    }

    .chevron_arrow {
      width: 100%;
      height: 100%;
      fill: #000;
    }

    .chapter_thumbnail {
      border-radius: 10px;
      border: 2px solid #FFF;
      box-sizing: border-box;
      filter: drop-shadow(0px 2px 2px #4b4b4b);
    }

    .chapter_col {
      margin: 12px 6px;
      width: min-content;
    }

    .chapter_col:nth-child(1) {
      margin-left: 0px;
    }

    .chapter_col:nth-last-child(-n + 1) {
      margin-right: 0px;
    }

    .chapter_anchor {
      display: block;
      text-decoration: none;
      padding: 4px;
      border-radius: 10px;
      transition: background-color 0.5s ease;
      cursor: pointer;
      height: 100%;
    }

    .chapter_anchor:hover {
      background-color: #d5d5d5;
      text-decoration: none;
    }

    .chapter_anchor:hover .chapter_thumbnail {
      filter: drop-shadow(0px 2px 2px #FFF);
    }

    .chapter_description {
      color: #000;
      margin: 4px 0px;
      padding-left: 2px;
      font-size: .9em;
    }

    .chapter_time {
      margin: 5px 0px 0px 0px;
      color: #065FD4;
      padding-left: 2px;
      font-size: .9em;
    }
  </style>
</head>

<body>
  <div id="video_details">
    <label class="label">Video ID: <input id="video_id" type="text" placeholder=""></label>
    <button id="load_video_button">Set Video</button>
    <div class="label" id="video_error"></div>
  </div>
  <div id="container">
    <div id="output">
      <p id="debug">Mediainfo <code>cuePoints</code> data</p>
      <code style="color: green;" id="insertionPoint_MI"></code>
      <p id="debug">Activecues <code>cues</code> data</p>
      <code style="color:brown;" id="insertionPoint_C"></code>
      <p id="debug">Activecues <code>activeCue</code> data</p>
      <code id="insertionPoint_AC"></code>
    </div>
    <div style="max-width: 960px; margin: 0px 0px auto 0px;" id="video">
      <style>
        video-js.video-js.vjs-fluid:not(.vjs-audio-only-mode) {
          padding-top: 56.25%;
        }
      </style>
      <video-js 
        id="myPlayer" 
        data-account="5380177774001" 
        data-player="default" 
        data-embed="default" 
        controls=""
        playsinline data-video-id="1765369433160630106" 
        data-playlist-id="" 
        data-application-id="" 
        class="vjs-fluid">
      </video-js>
    </div>
  </div>
  <script src="//players.brightcove.net/5380177774001/default_default/index.min.js"></script>
  <script type="text/javascript">
    var options = { 
        "cue_marker_color": "#FCF",
        "chapter_bg_color": "WhiteSmoke",
        "thumbnail_w": "144"
    };
    videojs.getPlayer('myPlayer').ready(function () {
      var myPlayer = this;
      myPlayer.cuePointChaptersPlugin(options);
    });
    const loadPlayerVideo = () => {
      const videoIdInput = document.getElementById("video_id");
      // Check for a video value
      if (videoIdInput.value === '') {
        videoIdInput.placeholder = 'Please add video ID';
        return;
      }
      myPlayer.player.catalog.getVideo(videoIdInput.value, function (error, video) {
        if (error) {
          document.getElementById('video_error').innerHTML = 'Video ID invalid please try again';
          return;
        } else {
          document.getElementById('video_error').innerHTML = '';
          myPlayer.player.catalog.load(video);
          myPlayer.player.muted(true);
        }
      })
    }
    document.getElementById('load_video_button').addEventListener('click', loadPlayerVideo);
    videojs.registerPlugin('cuePointChaptersPlugin', function (options) {
    var player = this;
    player.on('loadedmetadata', function () {
        let cuePointsArr = new Array(),
            filteredCueArr = new Array(),
            purgedCueArr = new Array(),
            tt = player.textTracks()[0], // ********* Remove ********* for debugging purposes in standalone HTML example
            // Define the video duration as a variable
            videoDuration = player.mediainfo.duration,
            // Get Video Cloud metadata long description field
            longDesc = player.mediainfo.longDescription,
            // Define video ID for playlist player management
            videoId = player.mediainfo.id,
            // VTT URL based on player reference
            vtt_url = filterVttUrl(player);
        // Add existing cue point metadata to the cue points array
        for (let i = 0; i < player.mediainfo.cuePoints.length; i++) {
            cuePointsArr.push(player.mediainfo.cuePoints[i]);
        }
        // Check for chapters in the longDescription metadata field, sort and merge
        xtractMatch(longDesc, cuePointsArr, videoDuration, videoId);
        // Add to filtered array based on original
        filteredCueArr = cuePointsArr.filter(cue => (cue.type === 'CODE') || (cue.type === 'TEXT'));
        // Remove duplicates based on time and replace
        purgedCueArr = dedupeArr(filteredCueArr);
        // Assign endTime to cue points in sorted array
        assignCueEndTime(purgedCueArr, videoDuration);
        // Take purged cue point information and add cue markers to player progress bar
        addCueEl(purgedCueArr, videoDuration, options);
        // ********* Remove ********* for debugging purposes in standalone HTML example
        displayMetaInfo(tt, purgedCueArr);
        // Check for populated array and generate chapter bar-container
        if (purgedCueArr.length != 0) chapterThumbContainer(options), chapterThumbs(player, vtt_url, purgedCueArr, options);
        // If playlist player/playlist/chapters are present - clear UI elements for new playlist/media item
        player.on('loadstart', function() {rmChapterEl(), rmCueEl()});
      })
    });
    // ********* Remove ********* for debugging purposes in standalone HTML example
    const displayMetaInfo = (tt, arr) => {
      tt.oncuechange = function () {
        if (tt.activeCues[0] !== undefined) {
          var dynamicHTML_AC = "id: " + tt.activeCues[0].originalCuePoint.id + ", ";
          dynamicHTML_AC += "type: " + tt.activeCues[0].originalCuePoint.type + ", ";
          dynamicHTML_AC += "name: " + tt.activeCues[0].originalCuePoint.name + ", ";
          dynamicHTML_AC += "startTime: " + tt.activeCues[0].startTime + ",  ";
          dynamicHTML_AC += "endTime: " + tt.activeCues[0].endTime;
          document.getElementById("insertionPoint_AC").innerHTML += dynamicHTML_AC + "<br/>";
        }
      }
      let dynamicHTML_C = "",
        dynamicHTML_MI = "";
      for (i = 0; i < tt.cues.length; i++) {
        dynamicHTML_C += "id: " + tt.cues[i].originalCuePoint.id + ", ";
        dynamicHTML_C += "type: " + tt.cues[i].originalCuePoint.type + ", ";
        dynamicHTML_C += "name: " + tt.cues[i].originalCuePoint.name + ", ";
        dynamicHTML_C += "startTime: " + tt.cues[i].startTime + ", ";
        dynamicHTML_C += "endTime: " + tt.cues[i].endTime + "<br/>";
      }
      document.querySelector("#insertionPoint_C").innerHTML = dynamicHTML_C;
      for (i = 0; i < arr.length; i++) {
        dynamicHTML_MI += "id: " + arr[i].id + ", ";
        dynamicHTML_MI += "type: " + arr[i].type + ", ";
        dynamicHTML_MI += "name: " + arr[i].name + ", ";
        dynamicHTML_MI += "startTime: " + arr[i].startTime + ", ";
        dynamicHTML_MI += "endTime: " + arr[i].endTime + "<br/>";
      }
      document.querySelector("#insertionPoint_MI").innerHTML = dynamicHTML_MI;
    }

    // Check for Presence of VTT file or thumbnail enabled player
    const filterVttUrl = (player) => {
        if (typeof player.thumbnails === 'function'){
            const res = player.thumbnails();
            if (!res.metadataTrackEl_){
                console.log('Looks like a playlist player - No thumbnail VTT here');
                return vtt_url = player.mediainfo.thumbnail;
            } else {
                console.log('Thumbnail VTT detected - Building array');
                return vtt_url = res.metadataTrackEl_.src;
            }
        } else {
            console.log('Thumbnail VTT file not present');
            return vtt_url = player.mediainfo.thumbnail;
        }
    }

    const xtractMatch = (string, arr, videoDuration, videoId) => {
      if (string === null) return (arrSort(arr));
      // Match time formats M:SS, MM:SS, HH:MM:SS, H:MM:SS
      let tRex = new RegExp(/(^(?:[01]\d|2[0-3]|[0-59]):[0-5]\d:[0-5]\d)|(^(?:[0-5]\d|2[123]|[0-59]):[0-5]\d)/gm),
        // Match whole line that begins with 00: Lines with time format not at the beginning are ignored
        dRex = new RegExp(/^.*?(^[0-5][0-9]:|^[0-59]:).*$/gm),
        chaptrTime = string.match(tRex),
        chaptrName = string.match(dRex);
      // No found chapters - sort the array as it is and skip adding any further cue information
      if (chaptrTime === null) return (arrSort(arr));
      for (let i = 0; i < chaptrTime.length; i++) {
        let time = chaptrTime[i].split(':'),
          description = chaptrName[i].slice(chaptrTime[i].length),
          seconds,
          // Add ranomised 13 digit ID
          idNum = Math.floor(Math.random() * 9000000000000) + 1000000000000;
        // Strip hyphens and other intersting chars from string and trim whitespace    
        description = stringTidy(description);
        // push into array objects
        timeConversion(arr, time, idNum, seconds, description, videoDuration, videoId);
      }
      // Sort array based on time
      arrSort(arr);
    }

    const fetchVTTFile = async (url) => {
        try {
            const response = await fetch(url);
            const data = await response.text();
            return data;
        } catch (error) {
            console.error('Error fetching VTT file:', error);
            return null;
        }
    };

    const parseVTT = (vtt_data) => {
        const parser = new WebVTT.Parser(window, WebVTT.StringDecoder()),
        vtt_image_array = new Array();
        parser.oncue = function(cue) {
            vtt_image_array.push({ start: cue.startTime, end: cue.endTime, img_src: cue.text });
        };
        parser.parse(vtt_data);
        parser.flush();
        return vtt_image_array;
    };

    // Array sort - order array based on time from lowest to highest
    const arrSort = (arr) => {
      arr.sort((a, b) => {
        return a.time - b.time;
      });
    }

    // Removal of hyphens, pluses but allows inverted commas etc
    const stringTidy = (str) => {
      str = str.replace(/([.,\/;:*{}=\-_~()<>{}+])/g, '');
      // Remove whitespace form either end of the string
      str = str.trim();
      return (str);
    }

    const timeConversion = (arr, time, idNum, seconds, description, duration, videoId) => {
      // Check for words in description if none set fields to blank
      if (description.match(/\b[^\d\W]+\b/g) === null) description = '';
      if (time.length === 2) {
        // Convert MM:SS to seconds
        seconds = (Number.parseFloat(time[0]) * 60 + Number.parseFloat(time[1]));
        // If chapter is longer than the video skip
        if (seconds > duration) return;
        arr.push({
          id: `${idNum}`,
          name: description,
          type: 'TEXT',
          time: seconds,
          metadata: description,
          startTime: seconds,
          endTime: '',
          video_id: videoId
        });
      }
      if (time.length === 3) {
        // Convert HH:MM:SS to seconds
        seconds = (Number.parseFloat(time[0]) * 3600 + Number.parseFloat(time[1]) * 60 + Number.parseFloat(time[2]));
        // If chapter is longer than the video skip
        if (seconds > duration) return;
        arr.push({
          id: `${idNum}`,
          name: description,
          type: 'TEXT',
          time: seconds,
          metadata: description,
          startTime: seconds,
          endTime: '',
          video_id: videoId
        });
      }
    }

    // Filter array through map - remove duplicates
    const dedupeArr = (arr) => {
      let mapObj = new Map()
      arr.forEach(v => {
        let prevValue = mapObj.get(v.time)
        if (!prevValue) {
          mapObj.set(v.time, v)
        }
      })
      return [...mapObj.values()];
    }

    // Hacky method to reassign endTime cue data in array after arrSort
    const assignCueEndTime = (arr, duration) => {
      // Order the array on time again - for loop uses time from preceding array object 
      arrSort(arr);
      let v = 1;
      for (let i = 0; i < arr.length; i++) {
        if (v <= arr.length - 1) arr[i].endTime = arr[v].time;
        // If last object in array set end time to video duration
        if (v === arr.length) arr[i].endTime = duration;
        v++;
      }
    }

    // Build cue point markers and add them to the player progress bar
    const addCueEl = (arr, videoDuration, options) => {
        let playerWidth = document.querySelector('.video-js').offsetWidth,
            controlBar = document.querySelector('.vjs-progress-control'),
            progresBar = document.querySelector('.vjs-progress-holder'),
            cueControl = document.createElement('div'),
            cueTip = document.createElement('div');
        cueTip.className = 'vjs-cue-tip';
        cueControl.className = 'vjs-cue-control';
        cueControl.style.setProperty('--cue-control-width', playerWidth + 'px');
        controlBar.prepend(cueControl);
        progresBar.appendChild(cueTip);
        // Loop through array and add elements
        for (let i = 0; i < arr.length; i++) {
            let el = document.createElement('div');
            el.className = 'vjs-cue-marker';
            el.id = 'marker' + i;
            // Check of marker colour is set in the plugin JSON if not make them white
            if (!options.cue_marker_color || !/^(#[0-9a-f]{3,4}(?:[0-9a-f]{3,4})?|rgba?\(\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})(?:,\s*(0|1|0?\.\d+))?\s*\)|[a-z]+)$/i.test(options.cue_marker_color)) options.cue_marker_color = "#FFF";
            el.style.setProperty('--marker-color', options.cue_marker_color);
            // On mouse over event - add mouse event listener to cue marker elements
            el.addEventListener("mouseover", (e) => {
                setCueInfo(e, arr);
            });
            let time = arr[i].time;
            // Based on proportion of width in px using time 
            el.style.left = `${Math.round(time / videoDuration * playerWidth)}px`;
            cueControl.append(el);
        }
        // Create the inner placeholder for the cue point data on the tooltips
        createCueInfoEl();
    }

    // Remove created elements if playlist is present and new video has loaded
    const rmCueEl = () => {
      let cueControl = document.querySelector('.vjs-cue-control'),
          cueTip = document.querySelector('.vjs-cue-tip');
      // document.getElementsByTagName('video-js')[0].style.overflow = "hidden";
      if (cueTip) cueTip.remove();
      if (cueControl) cueControl.remove();
    }

    // Remove created chapter tiles if playlist is present and new video has loaded
    const rmChapterEl = () => {
        let chapterControl = document.querySelector('#vjs-chapter-container');
        // Call observer to kill the mutation watcher - remove the chapter UI element and reset the carousel postion
        if (chapterControl) stopObserving(document.querySelector('#chapter_col_wrapper'), 0), chapterControl.remove(), currentPosition = 0;
    }

    // Create and introduce to DOM the information tool data
    const createCueInfoEl = () => {
      let cueTipData = document.createElement('p'),
        cueTip = document.querySelector('.vjs-cue-tip');
      cueTipData.className = 'vjs-cue-data';
      cueTip.appendChild(cueTipData);
    }

    // Create the chapter elements and add them to DOM
    const chapterThumbContainer = (options) => {
        let chapterContainer = document.createElement('div');
        chapterContainer.id = 'vjs-chapter-container';
        chapterContainer.innerHTML = `
            <div id="chapter_title_container">
                <h3 id="chapter_title">Chapters</h3>
            </div>
            <div id="chapter_left_arrow_container" class="chapter_arrow_container">
                <div id="chapter_left_arrow" class="chapter_arrow">
                <div id="chapter_chevron_left" class="chapter_arrow_chevron">
                    <div class="chapter_chevron_shape">
                    <div class="chevron_shape">
                        <div class="chevron_arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" focusable="false" style="pointer-events: none; display: block; width: 100%; height: 100%;">
                            <path d="M14.96 18.96 8 12l6.96-6.96.71.71L9.41 12l6.25 6.25-.7.71z"></path>
                        </svg>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
                <div id="chapter_left_arrow_button"></div>
            </div>
            <div id="chapter_col_container">
                <div id="chapter_col_wrapper"></div>
            </div>
            <div id="chapter_right_arrow_container" class="chapter_arrow_container">
                <div id="chapter_right_arrow" class="chapter_arrow">
                <div id="chapter_chevron_right" class="chapter_arrow_chevron">
                    <div class="chapter_chevron_shape">
                    <div class="chevron_shape">
                        <div class="chevron_arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" focusable="false" style="pointer-events: none; display: block; width: 100%; height: 100%;">
                            <path d="m9.4 18.4-.7-.7 5.6-5.6-5.7-5.7.7-.7 6.4 6.4-6.3 6.3z"></path>
                        </svg>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
                <div id="chapter_right_arrow_button"></div>
            </div>
        `
        // Check whether chapter bacground colour is set in the plugin JSON if not make it transparent
        if (!options.chapter_bg_color || !/^(#[0-9a-f]{3,4}(?:[0-9a-f]{3,4})?|rgba?\(\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})(?:,\s*(0|1|0?\.\d+))?\s*\)|[a-z]+)$/i.test(options.chapter_bg_color)) options.chapter_bg_color = 'transparent';
        chapterContainer.style.setProperty('--chapter-color', options.chapter_bg_color);
        document.querySelector('video-js').insertAdjacentElement('afterend', chapterContainer);
    }

    // Control mouse interaction with the cue markers - Initiated on hover state
    const setCueInfo = (e, arr) => {
      let i = e.target.id.slice(6),
        cueHolder = document.querySelector('.vjs-cue-control').offsetWidth,
        cueMarker = document.querySelectorAll('.vjs-cue-marker')[i],
        cueTip = document.querySelector('.vjs-cue-tip'),
        cueTipData = document.querySelector('.vjs-cue-data');
      cueTip.classList.add('vjs-cue-tip-visible');
      cueTipData.innerHTML = `${arr[i].name}`;
      cueTip.style.display = null;
      // Display cue tool tip on left or right of marker on hover based on position
      if (cueMarker.offsetLeft > cueHolder / 2) {
        cueTipData.classList.remove('vjs-cue-data-right');
        cueTipData.classList.add('vjs-cue-data-left');
        cueTip.style.left = null;
        cueTip.style.right = cueHolder - cueMarker.offsetLeft + 20 + 'px';
      } else {
        if (arr[i].time === 0) cueMarker.classList.add('initial-marker');
        cueTipData.classList.remove('vjs-cue-data-left');
        cueTipData.classList.add('vjs-cue-data-right');
        cueTip.style.right = null;
        cueTip.style.left = cueMarker.offsetLeft + 20 + 'px';
      }
      if (arr[i].name === '') cueTip.style.display = 'none';
      // Mouse move event - follow the mouse pointer on Y axis only
      cueMarker.addEventListener('mousemove', (e) => {
        cueTip.style.top = e.offsetY - 27 + 'px';
      });
      // On mouse out event - remove inline styles and classes
      cueMarker.addEventListener('mouseout', () => {
        cueTip.classList.remove('vjs-cue-tip-visible');
      });
    }

    const matchVttTime = (url, seconds, vtt_image_array) => {
      if (!vtt_image_array[0]) return url;
      const increment = vtt_image_array[0].end - vtt_image_array[0].start;
      seconds = Math.round(seconds / increment) * increment;
      let time_match = vtt_image_array.find(obj => obj.start === seconds);
      // For thumbnail enabled player provide VTT based image src otherwise use a poster image for each thumbnail
      return time_match ? time_match.img_src : url;
    }

    // Convert time in seconds back to digital HH:MM:SS format or MM:SS depending on duration
    const convertTime = (seconds) => {
      seconds = Math.round(seconds);
      let hours = Math.floor(seconds / 3600),
          minutes = Math.floor((seconds % 3600) / 60), // Fix minutes calculation
          remainderSeconds = seconds % 60;
      if (seconds >= 3600) {
        return (hours < 10 ? '0' + hours : hours) + ":" +
              (minutes < 10 ? '0' + minutes : minutes) + ":" + // Minutes fixed
              (remainderSeconds < 10 ? '0' + remainderSeconds : remainderSeconds);
      } else {
        // No change needed here, but clarified the condition
        return (minutes < 10 ? '0' + minutes : minutes) + ":" +
              (remainderSeconds < 10 ? '0' + remainderSeconds : remainderSeconds);
      }
    }

    // Generate the chapter thumbnails based on data in the filtered array
    const chapterThumbs = (player, url, arr, dim) => {
        const chapter_arrow_container = document.querySelectorAll('.chapter_arrow_container'),
            chapter_left_arrow_button = document.querySelector('#chapter_left_arrow'),
            chapter_right_arrow_button = document.querySelector('#chapter_right_arrow'),
            chapter_col_wrapper = document.querySelector('#chapter_col_wrapper');
        const get_vtt_data = async () => {
            let vtt_image_array;
            // Fetch the VTT fle basef on plyer reference
            vtt_data = await fetchVTTFile(url);
            // Parse the VTT into array
            vtt_image_array = parseVTT (vtt_data);
            // Check if dimensions are present in the plugin config JSON
            if (!dim.thumbnail_w || !/^\d+$/.test(dim.thumbnail_w)) dim.thumbnail_w = '144';
            // Loop through and build array
            for (let i = 0; i < arr.length; i++) {
                let chapter_col = document.createElement('div');
                chapter_col.classList.add('chapter_col');
                let vtt_img_src;
                vtt_img_src = matchVttTime(url, arr[i].time, vtt_image_array);
                chapter_col.innerHTML = `
                    <div class="chapter_anchor">
                      <img class="chapter_thumbnail" src="${vtt_img_src}" style="width: ${dim.thumbnail_w}px;">
                        <div class="chapter_details">
                        <div class="chapter_time">${convertTime(arr[i].time)}</div>
                            <h4 class="chapter_description">${arr[i].name}</h4>
                        </div>
                    </div>
                `;
                chapter_col_wrapper.appendChild(chapter_col);
                let chapter_anchor = document.querySelectorAll('.chapter_anchor');
                // Adding event listener on chapters for each video cue point
                chapter_anchor[i].addEventListener('click', function(){
                    player.currentTime(arr[i].time);
                    player.play();
                });
            }
        }
        get_vtt_data();
        // Add event listener to the arrpow buttons
        chapter_left_arrow_button.addEventListener('click', () => checkCarouselOverflow('left'));
        chapter_right_arrow_button.addEventListener('click', () => checkCarouselOverflow('right'));
        if (arr.length <= 5) {
            chapter_arrow_container.forEach(function (element) {
                element.style.display = 'none';
            })
        }
        onElementAdded(chapter_col_wrapper);
    }

    // Add the observer to watch carousel wrapper as page loads to updaate element width for scroll
    function onElementAdded(chapter_col_wrapper) {
      if (chapter_col_wrapper) {
        resizeObserver.observe(chapter_col_wrapper);
      }
    }

    // Callback to check mutation of the chapter wrapper element
    const resizeObserverCallback = entries => {
      checkCarouselOverflow();
    };

    // Function to call document.querySelector('#chapter_col_wrapper') as the element and stop the mutation observer
    const stopObserving = (element, timeout) => {
        if (!resizeObserver) return console.log('No mutation observer present.');
        if (timeout > 0) {
            setTimeout(() => {
                resizeObserver.unobserve(element);
                console.log('Stopped observing after timeout.');
            }, timeout);
        } else {
            resizeObserver.unobserve(element);
            console.log('Stopped observing immediately.');
        }
    };

    // Get boundaries of chapter window (parent) and the wrapper (child) calculate offset and display controls
    const resizeObserver = new ResizeObserver(resizeObserverCallback);
    let currentPosition = 0;
    const checkCarouselOverflow = (direction) => {
      const p = document.querySelector('#chapter_col_container'),
        c = document.querySelector('#chapter_col_wrapper'),
        chapter_left_arrow_button = document.querySelector('#chapter_left_arrow'),
        chapter_right_arrow_button = document.querySelector('#chapter_right_arrow'),
        chapter_col_count = document.querySelectorAll('.chapter_col').length,
        // Get number of elements in the carousel and divide that by the widh - added multiplier to create greater increment
        carousel_shift = Number(c.offsetWidth / chapter_col_count) * 5,
        maxTranslateLeft = 0,
        maxTranslateRight = -(c.offsetWidth - p.offsetWidth);
      // Display buttons based on boundaries
      const buttonVisibility = () => {
        chapter_left_arrow_button.style.display = currentPosition < maxTranslateLeft ? 'block' : 'none';
        chapter_right_arrow_button.style.display = currentPosition > maxTranslateRight ? 'block' : 'none';
        // resizeObserver.unobserve(c);
      }
      // Move the chapter thumbnails based on the calulated thumbnail width
      const moveEl = () => {
        if (direction === 'right') {
          currentPosition = Math.max(currentPosition - carousel_shift, maxTranslateRight);
        } else if (direction === 'left') {
          currentPosition = Math.min(currentPosition + carousel_shift, 0);
        }
        c.style.transform = `translateX(${currentPosition}px)`;
      }
      // Call the functions to move the elements (chapter wrapper) and diplay the appropriate buttons
      moveEl();
      buttonVisibility();
    }

    // Call the point in the video and play
    const chapterTime = (time) => {
      myPlayer.player.currentTime(time);
      myPlayer.player.play();
    }

  </script>
</body>

</html>